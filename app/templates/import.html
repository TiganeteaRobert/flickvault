{% extends "base.html" %}

{% block title %}Import â€” Flickvault{% endblock %}

{% block content %}
<a href="/" class="inline-flex items-center gap-1.5 text-sm text-zinc-500 hover:text-brand-400 transition-colors mb-4">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    Back to vault
</a>

<div class="mb-8">
    <h1 class="text-2xl sm:text-3xl font-extrabold text-zinc-100 mb-2">Import Movies</h1>
    <p class="text-zinc-500 text-sm">Upload a JSON file with movie data. Supports Trakt watchlist format and plain arrays.</p>
</div>

{% if not collections %}
<div class="rounded-xl bg-brand-500/10 border border-brand-500/20 px-5 py-4 text-brand-300 text-sm">
    No collections exist yet. <a href="/" class="font-semibold text-brand-400 hover:text-brand-300 transition-colors">Create one first</a>.
</div>
{% else %}
<div class="max-w-xl">
    <div class="glass-strong rounded-2xl p-6">
        <form id="import-form" class="space-y-5">
            <div>
                <label for="collection" class="block text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-1.5">Collection</label>
                <select name="collection_id" id="collection" required
                        class="w-full rounded-xl bg-white/[0.04] border border-white/[0.08] px-4 py-2.5 text-sm text-zinc-200 focus:border-brand-500/50 transition-colors appearance-none cursor-pointer">
                    {% for c in collections %}
                    <option value="{{ c.id }}">{{ c.name }} ({{ c.movie_count }} movies)</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="file" class="block text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-1.5">JSON File</label>
                <input type="file" name="file" id="file" accept=".json" required
                       class="w-full rounded-xl bg-white/[0.04] border border-white/[0.08] px-4 py-2.5 text-sm text-zinc-200 file:mr-4 file:rounded-lg file:border-0 file:bg-brand-500/20 file:text-brand-400 file:px-4 file:py-1.5 file:text-sm file:font-semibold file:cursor-pointer focus:border-brand-500/50 transition-colors">
            </div>

            <button type="submit" id="import-btn"
                    class="w-full sm:w-auto rounded-xl bg-brand-500 text-surface-950 font-bold px-7 py-2.5 hover:bg-brand-400 hover:shadow-lg hover:shadow-brand-500/20 transition-all text-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed btn-press">
                <span id="import-btn-text">Import</span>
                <svg id="import-spinner" class="hidden animate-spin w-4 h-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
            </button>
        </form>
    </div>

    <div id="result" class="hidden mt-6 rounded-xl px-5 py-3.5 text-sm"></div>
</div>

<script>
document.getElementById('import-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const collectionId = form.collection_id.value;
    const formData = new FormData();
    formData.append('file', form.file.files[0]);

    const btn = document.getElementById('import-btn');
    const btnText = document.getElementById('import-btn-text');
    const spinner = document.getElementById('import-spinner');

    btn.disabled = true;
    btnText.textContent = 'Importing...';
    spinner.classList.remove('hidden');

    const resp = await fetch(`/api/collections/${collectionId}/import`, {
        method: 'POST',
        headers: { ...flickvaultHeaders() },
        body: formData
    });
    const data = await resp.json();

    btn.disabled = false;
    btnText.textContent = 'Import';
    spinner.classList.add('hidden');

    const resultDiv = document.getElementById('result');
    resultDiv.className = 'mt-6 rounded-xl px-5 py-3.5 text-sm';

    if (resp.ok) {
        resultDiv.classList.add('bg-emerald-500/10', 'border', 'border-emerald-500/20', 'text-emerald-300');
        resultDiv.innerHTML = `<strong>${data.added}</strong> added, <strong>${data.skipped}</strong> already existed (${data.total} total). <a href="/collections/${collectionId}" class="font-semibold text-emerald-400 hover:text-emerald-300 transition-colors">View collection</a>`;
    } else {
        resultDiv.classList.add('bg-rose-500/10', 'border', 'border-rose-500/20', 'text-rose-300');
        resultDiv.textContent = data.detail || 'Import failed';
    }
});
</script>
{% endif %}
{% endblock %}
