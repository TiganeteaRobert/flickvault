{% extends "base.html" %}

{% block title %}Collections â€” Flickvault{% endblock %}

{% block content %}
<!-- AI Collection Builder Hero -->
<div class="mb-12 rounded-3xl overflow-hidden mesh-gradient p-6 sm:p-8">
    <div>
        <div class="flex items-center gap-2 mb-3">
            <span class="text-2xl">âœ¨</span>
            <span class="text-xs font-bold uppercase tracking-widest text-brand-400">AI-Powered</span>
        </div>
        <h1 class="text-2xl sm:text-3xl font-extrabold text-white mb-2 leading-tight">What are you in the mood for?</h1>
        <p class="text-zinc-400 mb-6 text-sm max-w-lg">Describe your vibe and AI will curate a collection with posters and summaries. Like having a movie-buff friend who knows everything.</p>

        <form id="generate-form" class="space-y-3">
            <div class="flex flex-col sm:flex-row gap-3">
                <input
                    type="text"
                    name="prompt"
                    id="gen-prompt"
                    placeholder='e.g. "Cozy rainy day movies" or "Mind-bending thrillers"'
                    required
                    class="flex-1 rounded-xl px-4 py-3 bg-white/[0.07] border border-white/[0.1] text-white placeholder-zinc-500 focus:border-brand-500/50 focus:bg-white/[0.1] transition-all text-sm"
                >
                <select name="media_type" id="gen-media-type" class="rounded-xl px-4 py-3 bg-white/[0.07] border border-white/[0.1] text-white focus:border-brand-500/50 transition-all text-sm appearance-none cursor-pointer">
                    <option value="movie" selected>Movies</option>
                    <option value="show">TV Shows</option>
                </select>
                <select name="movie_count" id="gen-count" class="rounded-xl px-4 py-3 bg-white/[0.07] border border-white/[0.1] text-white focus:border-brand-500/50 transition-all text-sm appearance-none cursor-pointer">
                    <option value="5">5 movies</option>
                    <option value="10" selected>10 movies</option>
                    <option value="15">15 movies</option>
                    <option value="20">20 movies</option>
                    <option value="25">25 movies</option>
                </select>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <input
                    type="text"
                    name="collection_name"
                    id="gen-name"
                    placeholder="Collection name (optional â€” AI picks one)"
                    class="flex-1 rounded-xl px-4 py-3 bg-white/[0.07] border border-white/[0.1] text-white placeholder-zinc-500 focus:border-brand-500/50 focus:bg-white/[0.1] transition-all text-sm"
                >
                <select name="min_rating" id="gen-min-rating" class="rounded-xl px-4 py-3 bg-white/[0.07] border border-white/[0.1] text-white focus:border-brand-500/50 transition-all text-sm appearance-none cursor-pointer">
                    <option value="" selected>Any rating</option>
                    <option value="4">4+ rating</option>
                    <option value="4.5">4.5+ rating</option>
                    <option value="5">5+ rating</option>
                    <option value="5.5">5.5+ rating</option>
                    <option value="6">6+ rating</option>
                    <option value="6.5">6.5+ rating</option>
                    <option value="7">7+ rating</option>
                    <option value="7.5">7.5+ rating</option>
                    <option value="8">8+ rating</option>
                </select>
                <button type="submit" id="gen-btn" class="rounded-xl bg-brand-500 text-surface-950 font-bold px-7 py-3 hover:bg-brand-400 hover:shadow-lg hover:shadow-brand-500/25 transition-all text-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed btn-press">
                    <span id="gen-btn-text">Generate</span>
                    <svg id="gen-spinner" class="hidden animate-spin w-4 h-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                </button>
            </div>
        </form>
        <p id="gen-error" class="mt-3 text-rose-400 text-sm hidden"></p>
    </div>
</div>

{% if error %}
<div class="mb-6 rounded-xl bg-rose-500/10 border border-rose-500/20 px-4 py-3 text-rose-300 text-sm">
    {{ error }}
</div>
{% endif %}

<!-- Collections -->
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
        <h2 class="text-xl font-bold text-zinc-100">Your Vault</h2>
        {% if collections %}
        <span class="text-xs font-semibold text-zinc-500 bg-white/[0.04] px-2.5 py-0.5 rounded-full">{{ collections|length }}</span>
        {% endif %}
    </div>
    <button id="new-collection-toggle" class="text-sm font-semibold text-brand-400 hover:text-brand-300 transition-colors flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
        New
    </button>
</div>

<!-- New Collection Form (hidden by default) -->
<div id="new-collection-form" class="hidden mb-6 rounded-2xl glass-strong p-5">
    <form id="create-form" class="flex flex-col sm:flex-row gap-3">
        <input type="text" name="name" id="name" placeholder="Collection name" required
               class="flex-1 rounded-xl bg-white/[0.04] border border-white/[0.08] px-4 py-2.5 text-sm text-zinc-200 placeholder-zinc-600 focus:border-brand-500/50 transition-colors">
        <input type="text" name="description" id="description" placeholder="Description (optional)"
               class="flex-1 rounded-xl bg-white/[0.04] border border-white/[0.08] px-4 py-2.5 text-sm text-zinc-200 placeholder-zinc-600 focus:border-brand-500/50 transition-colors">
        <select name="media_type" id="create-media-type" class="rounded-xl bg-white/[0.04] border border-white/[0.08] px-4 py-2.5 text-sm text-zinc-200 focus:border-brand-500/50 transition-colors appearance-none cursor-pointer">
            <option value="movie">Movies</option>
            <option value="show">TV Shows</option>
        </select>
        <button type="submit" class="rounded-xl bg-brand-500 text-surface-950 font-semibold px-6 py-2.5 hover:bg-brand-400 transition-colors text-sm btn-press">Create</button>
    </form>
</div>

{% if collections %}
<div class="flex flex-col gap-3">
    {% for c in collections %}
    <a href="/collections/{{ c.id }}" class="collection-card group relative rounded-2xl block bg-surface-900 border border-white/[0.06]" style="aspect-ratio: 32/9; overflow: hidden;">
        <!-- Poster mosaic â€” clipped separately so scale doesn't bleed outside card -->
        <div class="collection-poster-wrap absolute inset-0 flex overflow-hidden rounded-2xl">
            {% if c.poster_urls %}
                {% for url in c.poster_urls %}
                <img src="{{ url }}" alt="" class="collection-poster h-full flex-1 object-cover" loading="lazy">
                {% endfor %}
            {% else %}
            <div class="w-full flex items-center justify-center">
                <span class="text-5xl opacity-10">ðŸŽ¬</span>
            </div>
            {% endif %}
        </div>

        <!-- Gradient scrim -->
        <div class="collection-scrim absolute inset-0" style="background: linear-gradient(to top, rgba(5,5,7,0.97) 0%, rgba(5,5,7,0.55) 45%, rgba(5,5,7,0.1) 75%, transparent 100%);"></div>

        <!-- Content overlay -->
        <div class="absolute inset-0 flex flex-col justify-end px-4 pb-4">
            <!-- Badges row -->
            <div class="flex items-center gap-1.5 mb-2">
                <span class="inline-flex items-center rounded-full bg-white/10 backdrop-blur-sm px-2.5 py-0.5 text-[11px] font-semibold text-white/70 border border-white/[0.12]">
                    {% if c.media_type == "show" %}{{ c.movie_count }} show{{ "s" if c.movie_count != 1 else "" }}
                    {% else %}{{ c.movie_count }} movie{{ "s" if c.movie_count != 1 else "" }}{% endif %}
                </span>
                {% if c.media_type == "show" %}
                <span class="inline-flex items-center rounded-full bg-indigo-500/30 backdrop-blur-sm px-2 py-0.5 text-[10px] font-bold text-indigo-200 border border-indigo-400/30">TV</span>
                {% endif %}
                {% if c.min_rating %}
                <span class="inline-flex items-center gap-0.5 rounded-full bg-brand-500/30 backdrop-blur-sm px-2 py-0.5 text-[10px] font-bold text-brand-200 border border-brand-400/30">
                    <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                    {{ "%.1f"|format(c.min_rating) }}+
                </span>
                {% endif %}
                <!-- Delete button -->
                <button onclick="deleteCollection(event, {{ c.id }}, this)" class="ml-auto p-1.5 rounded-full bg-black/30 backdrop-blur-sm text-white/40 hover:text-white hover:bg-rose-500/80 opacity-0 group-hover:opacity-100 transition-all duration-300" title="Delete collection">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Title -->
            <h3 class="font-semibold text-white text-2xl leading-snug">{{ c.name }}</h3>

            <!-- Description â€” hidden, slides up on hover -->
            {% if c.description %}
            <p class="collection-desc text-[12px] text-zinc-400 leading-relaxed line-clamp-2 mt-1">{{ c.description }}</p>
            {% endif %}
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-20">
    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-white/[0.03] mb-5">
        <span class="text-4xl">ðŸŽ¥</span>
    </div>
    <p class="text-lg font-semibold text-zinc-300 mb-2">Your vault is empty</p>
    <p class="text-sm text-zinc-500 max-w-sm mx-auto">Create a collection or let AI curate one for you. Describe your mood above and watch the magic happen.</p>
</div>
{% endif %}

<script>
// Toggle new collection form
document.getElementById('new-collection-toggle').addEventListener('click', () => {
    const form = document.getElementById('new-collection-form');
    form.classList.toggle('hidden');
    if (!form.classList.contains('hidden')) {
        document.getElementById('name').focus();
    }
});

// Create collection
document.getElementById('create-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = { name: form.name.value, description: form.description.value, media_type: form.media_type.value };
    const resp = await fetch('/api/collections', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    if (resp.ok) {
        window.location.reload();
    } else {
        const err = await resp.json();
        alert(err.detail || 'Error creating collection');
    }
});

// Delete collection
async function deleteCollection(e, id, btn) {
    e.preventDefault();
    e.stopPropagation();
    if (!confirm('Delete this collection?')) return;
    const resp = await fetch(`/api/collections/${id}`, { method: 'DELETE' });
    if (resp.ok) {
        btn.closest('.group').remove();
    }
}

// Dynamic count labels based on media type
const genMediaType = document.getElementById('gen-media-type');
const genCount = document.getElementById('gen-count');
function updateCountLabels() {
    const label = genMediaType.value === 'show' ? 'shows' : 'movies';
    Array.from(genCount.options).forEach(opt => {
        opt.textContent = `${opt.value} ${label}`;
    });
}
genMediaType.addEventListener('change', updateCountLabels);

// AI Generate
document.getElementById('generate-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('gen-btn');
    const btnText = document.getElementById('gen-btn-text');
    const spinner = document.getElementById('gen-spinner');
    const errorEl = document.getElementById('gen-error');

    btn.disabled = true;
    btnText.textContent = 'Thinking...';
    spinner.classList.remove('hidden');
    errorEl.classList.add('hidden');

    try {
        const resp = await fetch('/api/collections/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                prompt: document.getElementById('gen-prompt').value,
                movie_count: parseInt(document.getElementById('gen-count').value),
                collection_name: document.getElementById('gen-name').value || null,
                media_type: document.getElementById('gen-media-type').value,
                min_rating: document.getElementById('gen-min-rating').value ? parseFloat(document.getElementById('gen-min-rating').value) : null
            })
        });

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            const parts = buffer.split('\n\n');
            buffer = parts.pop();
            for (const part of parts) {
                let eventType = '', eventData = '';
                for (const line of part.split('\n')) {
                    if (line.startsWith('event: ')) eventType = line.slice(7);
                    else if (line.startsWith('data: ')) eventData = line.slice(6);
                }
                if (!eventData) continue;
                const parsed = JSON.parse(eventData);
                if (eventType === 'progress') {
                    btnText.textContent = `Found ${parsed.found}/${parsed.needed}, searching for more...`;
                } else if (eventType === 'complete') {
                    window.location.href = `/collections/${parsed.id}`;
                    return;
                } else if (eventType === 'error') {
                    throw new Error(parsed.detail || 'Generation failed');
                }
            }
        }
    } catch (err) {
        errorEl.textContent = err.message || 'Network error. Please try again.';
        errorEl.classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btnText.textContent = 'Generate';
        spinner.classList.add('hidden');
    }
});
</script>
{% endblock %}
